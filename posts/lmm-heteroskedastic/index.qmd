---
title: |
  Heteroskedastic Linear Mixed Models with 
  `glmmTMB` and the argument `dispformula`
author: Lukas Graz  
date: 2024-12-04  
format:
  html:
    toc: true
    toc-location: left
    toc-expand: true
# tags:
#   - simulation
#   - power
#   - lmm
---

# Abstract
- `glmmTMB` can model heteroskedastic data via the `dispformula` argument (c.f. section @sec-sim-dat-vis-w-disp). 
- Type I error rate is slightly inflated. Regardless if modeled on homo-/heteroskedastic data accounting/ignoring heteroskedasticity with lmer and glmmTMB

`glmmTMB` models dispersion as expected. **BUT** the Type I error rate is inflated for both (with and without `dispformula`)!


**Example**: 
```
glmmTMB(y ~ trt + (1|id), data = D, dispformula = ~trt)
```

**Note**: Before modelling heteroskedastic LMM try:

- fixing heteroskedasticity by transforming the response variable (log, sqrt, etc.)
- Simplify mixed model structure by aggregating data like done in [this post](../lmer-slopes-new)


# Setup Data Simulation
```{r}
#| code-fold: true
library(simr)
library(glmmTMB) 
library(ggplot2)
library(lmerTest)
library(car)
library(mcreplicate)

# set contrast sum:
options(contrasts = c("contr.sum", "contr.poly"))

# Design Matrix
X <- data.frame(
  id  = as.factor(rep(1:20, each = 10)),
  trt = as.factor(rep(c("A", "B", "C", "D"), each = 50))
)

# create NULL-lmer-model
model <- makeLmer(y ~ trt + (1|id), 
  fixef=  c(0,0,0,0),
  VarCorr = 2,
  data = X, 
  sigma = 1
  )

# heteroscedastic response
get_hetero_data <- function(n) {
  D <- X
  D$y <- simulate(model, 1)[[1]]
  D$y[D$trt %in% c("C", "D")] <- D$y[D$trt %in% c("C", "D")] + rnorm(nrow(D)/2, 0, 3)
  return(D)
}

# homoscedastic response
get_homo_data <- function(n) {
  D <- X
  D$y <- simulate(model, 1)[[1]]
  return(D)
}
```


# Visualize Data
## Raw heteroscedastic Data
```{r}
set.seed(123)
Dat_hetero <- get_hetero_data()
ggplot(Dat_hetero, aes(x=trt, y=y, color=id)) + geom_boxplot()
```

## Raw homoscedastic Data
```{r}
ggplot(get_homo_data(), aes(x=trt, y=y, color=id)) + geom_boxplot()
```

## Simulated Data from glmmTMB with Dispersion {#sec-sim-dat-vis-w-disp}
```{r}
Dat_hetero$y_disp <- simulate(
  glmmTMB(y ~ 0+trt + (1|id), data = Dat_hetero, dispformula = ~trt), 1)[[1]]
ggplot(Dat_hetero, aes(x=trt, y=y_disp, color=id)) + geom_boxplot()
```

## Simulated Data from glmmTMB without Dispersion
```{r}
Dat_hetero$y_nodisp <- simulate(
  glmmTMB(y ~ 0+trt + (1|id), data = Dat_hetero                    ), 1)[[1]]
ggplot(Dat_hetero, aes(x=trt, y=y_nodisp, color=id)) + geom_boxplot()
```

# Type I error rate (on heteroskedastic data)
```{r}
#| code-fold: true
#| code-summary: analysis functions code
anova.glmmTMB <- glmmTMB:::Anova.glmmTMB

PVAL_fun <- function(data_fun = get_hetero_data, 
                     model_fun = glmmTMB::glmmTMB, 
                     dispersion = FALSE){
  D <- data_fun()
  if(dispersion){
    fit <- model_fun(y ~ trt + (1|id), data = D,  dispformula = ~trt)
  } else {
    fit <- model_fun(y ~ trt + (1|id), data = D)
  }
  A <- anova(fit)
  C <- coef(summary(fit))$cond
  return(c(anova=A[1, ncol(A)], C[, ncol(C)]))
}

analysis <- function(nsim, ...){
  PVALs <- mc_replicate(nsim, PVAL_fun(...))
  cat("Ratio of significant p-values (Anova and coefficients):\n")
  print(rowMeans(PVALs < 0.05))
  cat("Kolmogorov-Smirnov test for uniform distribution of p-values:\n")
  print(apply(PVALs, 1, function(x) ks.test(x, punif)$p.value) |> signif(2))
  hist(PVALs, main="Histogram of (all pooled) p-values")
}

set.seed(123)
nsim <- 500
```

## `glmmTMB(y ~ trt + (1|id), dispformula = ~trt)` 
```{r}
analysis(
  nsim = nsim, 
  data_fun = get_hetero_data, 
  model_fun = glmmTMB::glmmTMB, 
  dispersion = TRUE)
```


## `glmmTMB(y ~ trt + (1|id))`
```{r}
analysis(
  nsim = nsim, 
  data_fun = get_hetero_data, 
  model_fun = glmmTMB::glmmTMB)
```

## `lmerTest::lmer(y ~ trt + (1|id))`
```{r}
analysis(
  nsim = nsim, 
  data_fun = get_hetero_data, 
  model_fun = lmerTest::lmer)
```

# Type I error rate (on homoskedastic data)
## `glmmTMB(y ~ trt + (1|id), dispformula = ~trt)`
```{r}
analysis(
  nsim = nsim, 
  data_fun = get_homo_data, 
  model_fun = glmmTMB::glmmTMB, 
  dispersion = TRUE)
```


## `glmmTMB(y ~ trt + (1|id))`
```{r}
analysis(
  nsim = nsim, 
  data_fun = get_homo_data, 
  model_fun = glmmTMB::glmmTMB)
```

## `lmerTest::lmer(y ~ trt + (1|id))`
```{r}
analysis(
  nsim = nsim, 
  data_fun = get_homo_data, 
  model_fun = lmerTest::lmer)
```
