{
  "hash": "6818d8cac6172b52fb37deaef0de9eb9",
  "result": {
    "markdown": "---\ntitle: Does the variance of the Random-Effect influence the p-values?\nauthor: Lukas Graz\ndate: 2023-12-18\npermalink: /posts/lmm-effect-of-block-variace\ntags: \n  - simulation\n  - power\n---\n\n\nWe study the classical setup of a randomized complete block design with 2 treatments, 2 replications per block and 5 blocks. We vary the variance of the block effect and study how the p-values of the treatment effect change.\n\n\n\n$$\n% equatiomatic::extract_eq(fit)\n\\begin{aligned}\n  \\operatorname{y}_{i}  &\\sim N \\left(\\alpha_{block(i)} + \\beta_{trt(i)}, \\sigma^2 \\right) \\\\\n    \\alpha_{j}  &\\sim N \\left(\\mu_{\\alpha_{j}}, {\\sigma_{\\alpha_{j}}}^2 \\right)\n    \\text{, for block j = 1,} \\dots \\text{,5}\\\\\n    % contr sum for \\beta_{trt(i)}:\n    \\beta_{1}  &= - \\beta_{2}  \\quad \\text{(contr.sum)}\n\\end{aligned}\n$$\n\n### TLDR\nThe p-values of the treatment effect are not influenced by the variance of the block effect in our example.\n\n## Simulate Data\n\n::: {.cell hash='lmm-effect-of-block-variance_cache/commonmark/unnamed-chunk-1_400f76ae7ab338e548930509bdfbe944'}\n\n```{.r .cell-code}\nlibrary(ggplot2)\nlibrary(lmerTest)\n\noptions(contrasts = c(\"contr.sum\", \"contr.poly\"))\n```\n:::\n\n::: {.cell hash='lmm-effect-of-block-variance_cache/commonmark/unnamed-chunk-2_f448553580e212769ef8dc43a6dc092b'}\n\n```{.r .cell-code}\n# simulate data for a linear mixed model\n# a randomized complete block design with 3 treatments, nblock blocks, nrep replicates per block\n# an observation error with standard deviation SD_noise and a block effect with standard deviation SD_block\n# a treatment effect with standard deviation SD_trt\nget_data <- function(nblock=5, nrep=2, SD_noise=3, SD_block=1, SD_trt=0) {\n  data <- expand.grid(\n    nrep = 1:nrep,\n    trt = as.factor(1:2),\n    block = as.factor(1:nblock)\n  )\n  block_effect <- SD_block * rnorm(nblock)[data$block]\n  noise <- SD_noise * rnorm(nrow(data))\n  trt_effect <- SD_trt * rnorm(nrow(data))[data$trt]\n  data$y <- trt_effect + block_effect + noise\n  data\n}\n```\n:::\n\n\n## Plot Function\n\n::: {.cell hash='lmm-effect-of-block-variance_cache/commonmark/unnamed-chunk-3_7be39c16f4744aadfbf15fee04e3c987'}\n\n```{.r .cell-code}\n# function that makes an interactions plot\nplot_interactions <- function(data, ...) {\n  with(data,\n  interaction.plot(\n      x.factor = trt,\n      trace.factor = block,\n      response = y,\n      type = \"b\",\n      legend = FALSE,\n      ...\n    )\n  )\n}\n```\n:::\n\n\n\n## Perform Analysis\n1. Get Data that only differs with respect to SD_block (increasing)  \n2. Plot the data for each SD_block \n3. Fit a model with lmer and lm for each SD_block  \n4. inspect how the estimates and standard errors of the treatmenteffect change with increasing SD_block  \n\n\n::: {.cell hash='lmm-effect-of-block-variance_cache/commonmark/unnamed-chunk-4_90153b458f49c93e684b3cddca684494'}\n\n```{.r .cell-code}\nSD_blocks <- 0:8\nfits <- vector(\"list\", length(SD_blocks)*2)\ndim(fits) <- c(length(SD_blocks), 2)\ndimnames(fits) <- list(paste0(\"SD_block=\",as.character(SD_blocks)), c(\"lmer\", \"lm\"))\n\npar(mfrow=c(3,3))\nfor(i in seq_along(SD_blocks)){\n  SD_block <- SD_blocks[i]\n\n  set.seed(2)\n  data <- get_data(SD_block=SD_block)\n  plot_interactions(data, main=paste0(\"SD_block=\", SD_block))\n  \n  # lmer\n  fits[[i,1]] <- lmer(y ~ trt + (1|block), data=data)\n  \n  # lm\n  fits[[i,2]] <- lm(y ~ trt + block, data=data)\n}; par(mfrow=c(1,1))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nboundary (singular) fit: see help('isSingular')\nboundary (singular) fit: see help('isSingular')\nboundary (singular) fit: see help('isSingular')\n```\n:::\n\n::: {.cell-output-display}\n![](lmm-effect-of-block-variance_files/figure-commonmark/unnamed-chunk-4-1.png)\n:::\n\n```{.r .cell-code}\n# apply a function to each element of a list-array\n# preserving the dimensions and dimnames\nelementwise_apply <- function(L, f){\n  L_applied <- lapply(L, f)\n  dim(L_applied) <- dim(L)\n  dimnames(L_applied) <- dimnames(L)\n  L_applied\n}\n\nsummary_coef_trt1 <- elementwise_apply(fits, function(fit) coef(summary(fit))[\"trt1\",])\n```\n:::\n\n\n## Results\nIllustration: How `summary_coef_trt1` looks like:\n\n::: {.cell hash='lmm-effect-of-block-variance_cache/commonmark/unnamed-chunk-5_d21e61a3d15f1a4d60d185c552a7a5ee'}\n\n```{.r .cell-code}\nsummary_coef_trt1[\"SD_block=5\",]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n$lmer\n  Estimate Std. Error         df    t value   Pr(>|t|) \n  -0.31258    0.85616   14.00000   -0.36510    0.72049 \n\n$lm\n  Estimate Std. Error    t value   Pr(>|t|) \n  -0.31258    0.85616   -0.36510    0.72049 \n```\n:::\n\n```{.r .cell-code}\n# estimate\nelementwise_apply(summary_coef_trt1, function(coef) coef[1])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n           lmer     lm      \nSD_block=0 -0.31258 -0.31258\nSD_block=1 -0.31258 -0.31258\nSD_block=2 -0.31258 -0.31258\nSD_block=3 -0.31258 -0.31258\nSD_block=4 -0.31258 -0.31258\nSD_block=5 -0.31258 -0.31258\nSD_block=6 -0.31258 -0.31258\nSD_block=7 -0.31258 -0.31258\nSD_block=8 -0.31258 -0.31258\n```\n:::\n\n```{.r .cell-code}\n# standard error\nelementwise_apply(summary_coef_trt1, function(coef) coef[2])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n           lmer    lm     \nSD_block=0 0.79971 0.85616\nSD_block=1 0.75889 0.85616\nSD_block=2 0.78422 0.85616\nSD_block=3 0.85616 0.85616\nSD_block=4 0.85616 0.85616\nSD_block=5 0.85616 0.85616\nSD_block=6 0.85616 0.85616\nSD_block=7 0.85616 0.85616\nSD_block=8 0.85616 0.85616\n```\n:::\n\n```{.r .cell-code}\n# p-value\nelementwise_apply(summary_coef_trt1, function(coef) coef[length(coef)])\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n           lmer    lm     \nSD_block=0 0.70048 0.72049\nSD_block=1 0.68528 0.72049\nSD_block=2 0.69488 0.72049\nSD_block=3 0.72049 0.72049\nSD_block=4 0.72049 0.72049\nSD_block=5 0.72049 0.72049\nSD_block=6 0.72049 0.72049\nSD_block=7 0.72049 0.72049\nSD_block=8 0.72049 0.72049\n```\n:::\n\n```{.r .cell-code}\n# random effect variance\nsapply(fits[,1], function(fit) VarCorr(fit)$block[1]) |> sqrt() |> signif(2) \n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSD_block=0 SD_block=1 SD_block=2 SD_block=3 SD_block=4 SD_block=5 SD_block=6 \n      0.00       0.00       0.00       0.73       2.50       3.70       4.90 \nSD_block=7 SD_block=8 \n      6.00       7.20 \n```\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}