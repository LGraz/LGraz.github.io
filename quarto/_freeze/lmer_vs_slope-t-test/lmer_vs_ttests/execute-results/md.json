{
  "hash": "92cd18b45c556bc437185caa0ab05915",
  "result": {
    "markdown": "---\ntitle: \"Testing Slopes in a LMM -- Should we Simplify?\"\nauthor: Lukas Graz\ndate: 2023-05-31\npermalink: /posts/lmm-equivalence-to-ttest\ncache: true\ntags: \n  - simulation\n  - power\n  - lmm\n---\n\n<script src=\"https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML\" type=\"text/javascript\"></script>\n\n# TLDR\nGiven a dataset as shown in the last plot, we consider the following analyses:  \n1. For each subject extract the slope and perform a simple t-test on the slopes  \n2. Fit `lmer(salery ~ slope + (1|subject))` and test if $\\beta_{slope} =0$  \n3.  Fit `lmer(salery ~ slope + (slope|subject))` and test if $\\beta_{slope} =0$  \n**Then:** 1 & 3 are valid (if data bal equally powerful) approaches and 2 is only valid if there is no individual slope.\n\n# Simulate Data\nSalary of subject $s$ at time $t$:\n$$\nsalary_{t}^{(s)} = t \\cdot (slope + d_s) + intercept_s + \\varepsilon_{t,s}\n$$\n- $d_s \\sim \\mathcal N(0, subjSlopeSD^2)$  \n- $intercept_s \\sim \\mathcal N(0, subjSD^2)$  \n- $\\varepsilon_{t,s} \\sim \\mathcal N(0, obsSD^2)$  \n\n\n::: {.cell hash='lmer_vs_ttests_cache/commonmark/unnamed-chunk-1_1076a5cf6b6e98581a96d4afd6797c74'}\n\n```{.r .cell-code}\nnsim <- 2000\n\nlibrary(mcreplicate) # for parallelization\nlibrary(ggplot2)\nlibrary(lmerTest)\n\n#' `nsub`: how many subjects (default: 6)\n#' `nyears`: how many years(default: 10)\n#' `obsSD`: standard deviation of noise (observation-level) (default: 15)\n#' `subjSD`: standard deviation of individual effect (default: 4)\n#' `slope`: shared increase of income per year (default: 5)\n#' `subjSlopeSD`: subject specific standard deviation from slope (default: 2)\nget_data <- function(nsub=6, nyears=10, \n                     obsSD=15, subjSD=4, \n                     slope=5, subjSlopeSD=2){\n  subj_intercept <- rep(rnorm(nsub, 0, subjSD), each=nyears)\n  subj_slope <- rep(rnorm(nsub, slope, subjSlopeSD), each=nyears)\n  data.frame(\n    subject = as.factor(rep(1:nsub, each = nyears)),\n    year = rep(1:nyears, times = nsub),\n    salary =  subj_intercept +  # subject effect\n              subj_slope*(1:nyears) + # individual slope\n              rnorm(nyears*nsub, 0, obsSD) # obsSD\n  )\n}\n```\n:::\n\n \n# Plot Data\n\n::: {.cell hash='lmer_vs_ttests_cache/commonmark/unnamed-chunk-2_48fa41d0f18cf10d56153f1c06c42f71'}\n\n```{.r .cell-code}\nplot_data <- function(main, ...){\n  ggplot(get_data(...), aes(x = year, y = salary, group = subject, color = subject)) +\n    geom_line() +\n    geom_point() +\n    labs(x = \"Year\", y = \"Salary\") +\n    theme_minimal() +\n    ggtitle(main)\n}\n```\n:::\n\n::: {.cell hash='lmer_vs_ttests_cache/commonmark/unnamed-chunk-3_d24c596ecbdaa7045e1ed7af3154321d'}\n\n```{.r .cell-code}\nset.seed(123)\nplot_data(\"Noisless, equal subjects\", obsSD=0, subjSD=0, subjSlopeSD=0)\n```\n\n::: {.cell-output-display}\n![](lmer_vs_ttests_files/figure-commonmark/unnamed-chunk-3-1.png)\n:::\n\n```{.r .cell-code}\nplot_data(\"Noisless, equal slopes\", obsSD=0, subjSlopeSD=0)\n```\n\n::: {.cell-output-display}\n![](lmer_vs_ttests_files/figure-commonmark/unnamed-chunk-3-2.png)\n:::\n\n```{.r .cell-code}\nplot_data(\"Noisless\", obsSD=0)\n```\n\n::: {.cell-output-display}\n![](lmer_vs_ttests_files/figure-commonmark/unnamed-chunk-3-3.png)\n:::\n\n```{.r .cell-code}\nplot_data(\"General case\")\n```\n\n::: {.cell-output-display}\n![](lmer_vs_ttests_files/figure-commonmark/unnamed-chunk-3-4.png)\n:::\n:::\n\n\n\n# Analysis Methods\n\n::: {.cell hash='lmer_vs_ttests_cache/commonmark/unnamed-chunk-4_dac2610da874258b84368832754420a1'}\n\n```{.r .cell-code}\nslopeTTest <- function(data){\n  fits <- lmList(salary ~ year | subject, data)\n  slopes <- coef(fits)[,\"year\"]\n  t_test <- t.test(slopes, mu = 0)\n  t_test$p.value\n}\n\nlmmRandItcpt <- function(data){\n  lmm <- lmer(salary ~ year + (1|subject), data = data)\n    summary(lmm)$coefficients[2, \"Pr(>|t|)\"]\n}\n\nlmmRandSlope <- function(data){\n  lmm <- lmer(salary ~ year + (year|subject), data = data)\n    summary(lmm)$coefficients[2, \"Pr(>|t|)\"]\n}\n\np_values <- function(...){\n  data <- get_data(...)\n  c(\n    slopeTTest = slopeTTest(data),\n    lmmRandItcpt = lmmRandItcpt(data),\n    lmmRandSlope = lmmRandSlope(data)\n  ) # if you cange the amount of arguments, change also the object \"Power\"\n}\n\nget_power <- function(...){\n  args <- list(...)\n  PVALS <- as.data.frame(t(\n  mc_replicate(nsim, do.call(p_values, args))\n  ))\n  # POWER:\n  sapply(lapply(PVALS, function(x) x<0.05), mean)\n}\n```\n:::\n\n\n# Power Calculations\n\n::: {.cell hash='lmer_vs_ttests_cache/commonmark/unnamed-chunk-5_2ab8dec5f43c25e5b5f66d8f423cfd17'}\n\n```{.r .cell-code}\nset.seed(123)\nARGS <- as.data.frame(rbind(\n  # NULL:\n  expand.grid( \n    nsub=6, \n    nyears=10, \n    obsSD=5, \n    subjSD=4, \n    slope=0, \n    subjSlopeSD=c(0,4)),\n  # Change standard deviations and effects:\n  expand.grid(\n    nsub=6, \n    nyears=10, \n    obsSD=c(5,15), \n    subjSD=c(4, 12), \n    slope=c(2,4), \n    subjSlopeSD=c(1,4)),\n  # Change samplesize (allocation):\n  expand.grid(\n    nsub=c(6,10,20), \n    nyears=c(10,20), \n    obsSD=5, \n    subjSD=4, \n    slope=2, \n    subjSlopeSD=1)[-1,]\n))\nrownames(ARGS) <- NULL\n\nPower <- matrix(NA, nrow=nrow(ARGS), ncol=3)\ncolnames(Power) <- c(\"slopeTTest\", \n  \"lmmRandItcpt\", \"lmmRandSlope\")\n\nfor (i in 1:nrow(ARGS)){\n  args <- as.list(ARGS[i,])\n  Power[i,] <- do.call(get_power, args)\n}\n```\n:::\n\n# Show Results:\n\n::: {.cell hash='lmer_vs_ttests_cache/commonmark/unnamed-chunk-6_2056b8a7ea5f7de47332194e35680c46'}\n\n```{.r .cell-code}\nas.data.frame(cbind(ARGS, Power)) |> knitr::kable()\n```\n\n::: {.cell-output-display}\n| nsub| nyears| obsSD| subjSD| slope| subjSlopeSD| slopeTTest| lmmRandItcpt| lmmRandSlope|\n|----:|------:|-----:|------:|-----:|-----------:|----------:|------------:|------------:|\n|    6|     10|     5|      4|     0|           0|     0.0500|       0.0510|       0.0235|\n|    6|     10|     5|      4|     0|           4|     0.0475|       0.5100|       0.0475|\n|    6|     10|     5|      4|     2|           1|     0.9230|       0.9995|       0.9210|\n|    6|     10|    15|      4|     2|           1|     0.5580|       0.8065|       0.5255|\n|    6|     10|     5|     12|     2|           1|     0.9315|       1.0000|       0.9315|\n|    6|     10|    15|     12|     2|           1|     0.5335|       0.7925|       0.5155|\n|    6|     10|     5|      4|     4|           1|     1.0000|       1.0000|       1.0000|\n|    6|     10|    15|      4|     4|           1|     0.9760|       0.9985|       0.9760|\n|    6|     10|     5|     12|     4|           1|     1.0000|       1.0000|       1.0000|\n|    6|     10|    15|     12|     4|           1|     0.9755|       1.0000|       0.9755|\n|    6|     10|     5|      4|     2|           4|     0.1670|       0.7395|       0.1680|\n|    6|     10|    15|      4|     2|           4|     0.1340|       0.6015|       0.1280|\n|    6|     10|     5|     12|     2|           4|     0.1730|       0.7240|       0.1730|\n|    6|     10|    15|     12|     2|           4|     0.1555|       0.5830|       0.1520|\n|    6|     10|     5|      4|     4|           4|     0.5100|       0.9655|       0.5100|\n|    6|     10|    15|      4|     4|           4|     0.4550|       0.9000|       0.4465|\n|    6|     10|     5|     12|     4|           4|     0.5115|       0.9645|       0.5110|\n|    6|     10|    15|     12|     4|           4|     0.4395|       0.9175|       0.4355|\n|   10|     10|     5|      4|     2|           1|     0.9970|       1.0000|       0.9970|\n|   20|     10|     5|      4|     2|           1|     1.0000|       1.0000|       1.0000|\n|    6|     20|     5|      4|     2|           1|     0.9615|       1.0000|       0.9615|\n|   10|     20|     5|      4|     2|           1|     0.9990|       1.0000|       0.9990|\n|   20|     20|     5|      4|     2|           1|     1.0000|       1.0000|       1.0000|\n:::\n:::\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}