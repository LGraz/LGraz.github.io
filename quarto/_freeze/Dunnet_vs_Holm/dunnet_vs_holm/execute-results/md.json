{
  "hash": "e53c6ecdfbc0a04a72d8ac91d45fa690",
  "result": {
    "markdown": "---\ntitle: \"Contrasts against Control: Dunnet vs. Holm vs. TukeyHSD\"\nauthor: Lukas Graz\ndate: 2023-05-04\npermalink: /posts/dunnet-vs-holm-vs-tukeyhsd\ntags: \n  - simulation\n  - power\n---\n\n\n# TLDR\nEven though Dunnet is proven to be optimal (in all vs comparison) for a reasonable group number (around 10) Holm seems to yield basically the same result, while being a more general method. Dunnet is more powerful, when increasing the group number (e.g., to 30).\n\n# Purpose and Structure of this Document\n\nIn many cases, we may want to compare new alternatives to a standard treatment or control. To do this, we use a linear model and perform hypothesis testing of all alternatives versus the control. The purpose of this document is to compare the power of different multiple testing techniques.\n\nThe document is structured as follows:\n\n1. Define helper functions, including:\n      - data generation\n      - multiple testing functions\n      - wrapper for simulations\n2. Perform simulations for various settings.\n3. Plot the results.\n\nNote, that there are different definitions of \"power\" in this context. We will be using the following definitions:\n\n- The expectation that any of the non-placebos will be rejected.\n- The expectation of the fraction of non-placebos that will be rejected.\n- The expectation that all non-placebos will be rejected.\n\n# Help functions\n\n::: {.cell hash='dunnet_vs_holm_cache/commonmark/unnamed-chunk-1_dbc3594497a9df4a2416be7908905034'}\n\n```{.r .cell-code}\nset.seed(123)\nn_rep <- 1000\n\nlibrary(multcomp)\nlibrary(PMCMRplus)\nlibrary(ggplot2)\n\n# g groups, of which one is the control, n_effect of which have the effect `effect`\nget_data <- function(g = 10, n_t = 5, n_c = 5, effect = 1, n_effect = 3) {\n  fac <- as.factor(\n    rep(c(\"ctrl\", c(LETTERS, letters)[1:(g - 1)]), \n    c(n_c, rep(n_t, g - 1)))\n    )\n  groups <- relevel(fac, ref = \"ctrl\")\n  y <- rnorm(groups, \n    c(rep(0, length(groups) - n_t * n_effect), rep(effect, n_t * n_effect))\n    )\n  data.frame(group = groups, y = y)\n}\n\nholm <- function(data) {\n  fit <- lm(y ~ group, data)\n  p_vals <- summary(fit)$coefficients[-1, \"Pr(>|t|)\"]\n  p.adjust(p_vals)\n}\n\nnone <- function(data) {\n  fit <- lm(y ~ group, data)\n  summary(fit)$coefficients[-1, \"Pr(>|t|)\"]\n}\n\ntukey_hsd <- function(data) {\n  fit <- aov(y ~ group, data)\n  a <- TukeyHSD(fit)\n  contrasts <- grep(\"ctrl\", rownames(a$group), value = TRUE)\n  a$group[contrasts, \"p adj\"]\n}\n\n# multcomp implementation of \"dunnet\"\ndunn <- function(data) {\n  n <- table(data$group)\n  names(n) <- levels(data$group)\n  c(summary(\n    glht(aov(y ~ group, data), linfct = mcp(group = \"Dunnett\"))\n  )$test$pvalues)\n}\n\nall <- function(data) as.matrix(data.frame(none = none(data),\n  holm = holm(data), dunn = dunn(data), tukeyHSD = tukey_hsd(data))\n)\n\ndosim <- function(n_replicate = 200, n_goups = 10, n_treatmentgroup = 5, \n                  n_controlgroup = 5, effect = 1, n_non_placebo_treatments = 3) {\n  obj <- mcreplicate::mc_replicate(n_replicate, all(get_data(\n    g = n_goups, n_t = n_treatmentgroup, n_c = n_controlgroup, effect = effect, \n    n_effect = n_non_placebo_treatments\n  )))\n  stopifnot(effect > 0)\n  if (n_non_placebo_treatments == 0) {\n    p_val_non_placebo <- obj\n    p_val_non_placebo[, , ] <- 1 # this is used for power calc. In this case no effect\n  } else {\n    p_val_non_placebo <- obj[(n_goups - n_non_placebo_treatments):(n_goups - 1), , ]\n  }\n  p_val_no_effect <- obj[1:(n_goups - n_non_placebo_treatments - 1), , ]\n\n  # The fraction of rejected tests within the non-placebo treatments\n  MeanPower <- apply(p_val_non_placebo, 2, function(x) mean(x < 0.05))\n  names(MeanPower) <- paste0(\"MeanPower_\", names(MeanPower))\n\n  # The fraction where all non-placebo treatments where detected\n  AllPower  <- apply(p_val_non_placebo, c(2, 3), function(x) base::all(x < 0.05))\n  AllPower  <- apply(AllPower, 1, function(x) mean(x))\n  names(AllPower) <- paste0(\"AllPower_\", names(AllPower))\n\n  # The fraction where ANY non-placebo treatment was detected\n  AnyPower  <- apply(p_val_non_placebo, c(2, 3), function(x) base::any(x < 0.05))\n  AnyPower  <- apply(AnyPower, 1, function(x) mean(x))\n  names(AnyPower) <- paste0(\"AnyPower_\", names(AnyPower))\n\n  # The FWER under the NULL (i.e. for placebo treatments)\n  any_positive <- apply(p_val_no_effect, c(2, 3), function(x) any(x < 0.05))\n  alpha <- apply(any_positive, 1, function(x) mean(x))\n  names(alpha) <- paste0(\"alpha_\", names(alpha))\n\n  as.matrix(c(\n    n_replicate = n_replicate, n_goups = n_goups, \n    n_treatmentgroup = n_treatmentgroup, \n    n_controlgroup = n_controlgroup, effect = effect,\n    n_non_placebo_treatments = n_non_placebo_treatments,\n    MeanPower, AllPower, AnyPower, alpha\n  ), ncol = 1)\n}\n```\n:::\n\n\n# Simulations\n\n::: {.cell hash='dunnet_vs_holm_cache/commonmark/1_sim_5c5279c8f8c86272705a6faab68c36db'}\n\n```{.r .cell-code}\na <- dosim(n_replicate = n_rep, n_non_placebo_treatments = 0) # NULL\n```\n\n```{.r .cell-code}\ng <- dosim(n_replicate = n_rep)\n```\n\n```{.r .cell-code}\nb <- dosim(n_replicate = n_rep, effect = .5)\n```\n\n```{.r .cell-code}\nc <- dosim(n_replicate = n_rep, effect = 2)\n```\n\n```{.r .cell-code}\n# 12=floor(n_t * sqrt(g-1)) ==> taking 14 yields the same total sample size\nd <- dosim(n_replicate = n_rep, n_treatmentgroup = 4, n_controlgroup = 14) \n```\n\n```{.r .cell-code}\ne <- dosim(n_replicate = n_rep, n_treatmentgroup = 4, n_controlgroup = 14, effect = 2)\n```\n\n```{.r .cell-code}\nf <- dosim(n_replicate = n_rep, n_treatmentgroup = 4, n_controlgroup = 14, \n            n_non_placebo_treatments = 7)\n```\n:::\n\n::: {.cell hash='dunnet_vs_holm_cache/commonmark/2_sim_98e68b6f9825ef8900924ec2619ea421'}\n\n```{.r .cell-code}\nh <- dosim(n_replicate = n_rep, n_goups = 30, n_non_placebo_treatments = 3)\n```\n\n```{.r .cell-code}\ni <- dosim(n_replicate = n_rep, n_goups = 30, n_non_placebo_treatments = 10)\n```\n\n```{.r .cell-code}\nj <- dosim(n_replicate = n_rep, n_goups = 30, n_non_placebo_treatments = 20)\n```\n:::\n\n::: {.cell hash='dunnet_vs_holm_cache/commonmark/3_sim_cea4c05fa39faaf3b0e94c72c531c917'}\n\n```{.r .cell-code}\nk <- dosim(n_replicate = n_rep, n_treatmentgroup = 20, n_controlgroup = 20)\n```\n\n```{.r .cell-code}\n# optimal sample allocation with equal total\nl <- dosim(n_replicate = n_rep, n_treatmentgroup = 17, n_controlgroup = 47) \n```\n:::\n\n\n# Results\n\n::: {.cell hash='dunnet_vs_holm_cache/commonmark/unnamed-chunk-2_40312a4ae63727ee7a617a348bbd34fd'}\n\n```{.r .cell-code}\nresult <- cbind(\n  null=a, \n  default=g, \n  `-effect`=b, \n  `+effect`=c,\n  `+alloc` = d, \n  `+alloc+effect` = e, \n  `+nonplacebo_grps`=f,\n  `+grps`=h,\n  `+grps+nonplacebo`=i,\n  `+grps++nonplacebo`=j,\n  `+groupsize`=k,\n  `+grpsize+alloc`=l\n)\ncolnames(result) <- c(\"null\", \"default\", \"`-effect`\", \"`+effect`\", \"`+alloc`\", \n  \"`+alloc+effect`\", \"`+nonplacebo_grps`\", \"`+grps`\", \"`+grps+nonplacebo`\", \n  \"`+grps++nonplacebo`\", \"`+groupsize`\", \"`+grpsize+alloc`\"\n)\noptions(digits=4)\nresult |> as.data.frame() |> knitr::kable()\n```\n\n::: {.cell-output-display}\n|                         |     null|   default| `-effect`| `+effect`|  `+alloc`| `+alloc+effect`| `+nonplacebo_grps`|   `+grps`| `+grps+nonplacebo`| `+grps++nonplacebo`| `+groupsize`| `+grpsize+alloc`|\n|:------------------------|--------:|---------:|---------:|---------:|---------:|---------------:|------------------:|---------:|------------------:|-------------------:|------------:|----------------:|\n|n_replicate              | 1000.000| 1000.0000| 1000.0000| 1000.0000| 1000.0000|       1000.0000|          1000.0000| 1000.0000|          1000.0000|           1000.0000|    1000.0000|        1000.0000|\n|n_goups                  |   10.000|   10.0000|   10.0000|   10.0000|   10.0000|         10.0000|            10.0000|   30.0000|            30.0000|             30.0000|      10.0000|          10.0000|\n|n_treatmentgroup         |    5.000|    5.0000|    5.0000|    5.0000|    4.0000|          4.0000|             4.0000|    5.0000|             5.0000|              5.0000|      20.0000|          17.0000|\n|n_controlgroup           |    5.000|    5.0000|    5.0000|    5.0000|   14.0000|         14.0000|            14.0000|    5.0000|             5.0000|              5.0000|      20.0000|          47.0000|\n|effect                   |    1.000|    1.0000|    0.5000|    2.0000|    1.0000|          2.0000|             1.0000|    1.0000|             1.0000|              1.0000|       1.0000|           1.0000|\n|n_non_placebo_treatments |    0.000|    3.0000|    3.0000|    3.0000|    3.0000|          3.0000|             7.0000|    3.0000|            10.0000|             20.0000|       3.0000|           3.0000|\n|MeanPower_none           |    0.000|    0.3410|    0.1113|    0.8683|    0.4030|          0.9343|             0.3891|    0.3467|             0.3603|              0.3532|       0.8890|           0.9377|\n|MeanPower_holm           |    0.000|    0.1130|    0.0203|    0.6123|    0.1427|          0.7437|             0.1440|    0.0587|             0.0702|              0.0646|       0.6650|           0.7853|\n|MeanPower_dunn           |    0.000|    0.1283|    0.0257|    0.6407|    0.1453|          0.7317|             0.1393|    0.0787|             0.0847|              0.0762|       0.6837|           0.7777|\n|MeanPower_tukeyHSD       |    0.000|    0.0547|    0.0060|    0.4413|    0.0703|          0.5607|             0.0654|    0.0150|             0.0185|              0.0146|       0.4850|           0.6343|\n|AllPower_none            |    0.000|    0.1420|    0.0190|    0.7240|    0.1220|          0.8240|             0.0140|    0.1290|             0.0480|              0.0150|       0.7520|           0.8430|\n|AllPower_holm            |    0.000|    0.0240|    0.0010|    0.3900|    0.0160|          0.4800|             0.0010|    0.0090|             0.0000|              0.0010|       0.4430|           0.5530|\n|AllPower_dunn            |    0.000|    0.0250|    0.0010|    0.4050|    0.0140|          0.4430|             0.0010|    0.0150|             0.0000|              0.0000|       0.4480|           0.5310|\n|AllPower_tukeyHSD        |    0.000|    0.0050|    0.0000|    0.2140|    0.0030|          0.2640|             0.0000|    0.0020|             0.0000|              0.0000|       0.2520|           0.3400|\n|AnyPower_none            |    0.000|    0.5640|    0.2410|    0.9740|    0.7060|          0.9990|             0.9010|    0.5830|             0.8090|              0.8910|       0.9820|           0.9960|\n|AnyPower_holm            |    0.000|    0.2270|    0.0480|    0.8210|    0.3300|          0.9470|             0.4970|    0.1320|             0.2810|              0.3540|       0.8620|           0.9630|\n|AnyPower_dunn            |    0.000|    0.2650|    0.0620|    0.8550|    0.3420|          0.9520|             0.5160|    0.1730|             0.3350|              0.4210|       0.8920|           0.9680|\n|AnyPower_tukeyHSD        |    0.000|    0.1250|    0.0160|    0.6840|    0.1830|          0.8440|             0.2970|    0.0370|             0.1100|              0.1410|       0.7300|           0.9080|\n|alpha_none               |    0.277|    0.1860|    0.1980|    0.1960|    0.2410|          0.2530|             0.0890|    0.4260|             0.4340|              0.3030|       0.1900|           0.2280|\n|alpha_holm               |    0.035|    0.0310|    0.0170|    0.0290|    0.0290|          0.0430|             0.0130|    0.0330|             0.0300|              0.0140|       0.0330|           0.0290|\n|alpha_dunn               |    0.048|    0.0370|    0.0230|    0.0290|    0.0300|          0.0370|             0.0110|    0.0530|             0.0490|              0.0180|       0.0350|           0.0250|\n|alpha_tukeyHSD           |    0.010|    0.0110|    0.0040|    0.0070|    0.0090|          0.0100|             0.0030|    0.0080|             0.0040|              0.0000|       0.0030|           0.0040|\n:::\n:::\n\n\n\n# Plot\n\n::: {.cell hash='dunnet_vs_holm_cache/commonmark/plot_62d3d8012ae757974ed9853abf697608'}\n\n```{.r .cell-code}\nX <- result[-c(1:7, 11, 15, 19),] # remove \"none\" rows, and parameters \n\n# convert matrix to data frame\ndf <- data.frame(env = rep(colnames(X), each = nrow(X)), \n                 strategy = rep(rownames(X), times = ncol(X)),\n                 value = as.vector(X))\n\n# split the strategy names into two parts\ndf$part1 <- gsub(\"^(.*?)_.*$\", \"\\\\1\", df$strategy)\ndf$part2 <- gsub(\"^.*?_(.*)$\", \"\\\\1\", df$strategy)\n\n# plot\nplt <- ggplot(df, aes(x = factor(env, ordered=T, levels=unique(env)), y = value, \n  group = strategy, linetype = part1, color = part2)) + \n  geom_line() + \n  geom_point() +\n  scale_linetype_manual(\n    values = c(\"solid\", \"dashed\", \"dotted\", \"dotdash\")) +  # line types\n  theme(axis.text.x = element_text(angle = 30, hjust = 1)) # vertical x-labels \nplt\n```\n\n::: {.cell-output-display}\n![](dunnet_vs_holm_files/figure-commonmark/plot-1.png)\n:::\n:::\n\n\n# Results\n1. Dunnet and Holm yield very similar results when considering 10 groups (while varying the number of non-placebo groups, the effect, and the sample size allocation). \n2. Dunnet shows a slight advantage over Holm, when increasing the number of groups. \n3. The optimal allocation ($n_{control} = n_{treatments}\\sqrt{n_{groups}-1}$) yields an improvement as well in both cases.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}